<html>
    <head>
        <style>
            .map {
                width: 100%;
                height: 100%;
            }

            #qr {
                position: fixed;
                right: 0;
                bottom: 0;
            }
        </style>
    </head>
    <body>
        <div id="map" class="map">&nbsp;</div>
        <!-- NOTE: create an apiKey.js file that creates the global `apiKey` for this to work -->
        <script src="apiKey.js"></script>
        
        <!-- NOTE: create a firebaseConfig.js file that creates the global `firebaseConfig` for this to work -->
        <script src="firebaseConfig.js"></script>        
        <script>
            var sdkUrlTemplate = "https://maps.googleapis.com/maps/api/js?key={apiKey}&callback=initMap"
            var sdkUrl = sdkUrlTemplate.replace("{apiKey}", apiKey);
            var scriptTag = document.createElement("script");
            scriptTag.src = sdkUrl;
            scriptTag.async = true;
            scriptTag.defer = true;
            var body = document.body.insertBefore(scriptTag, document.getElementById("map"));
        </script>
        <script async defer>
            var map;

            var queryParams = function() {
                var urlSearchParams = new URLSearchParams(window.location.search);
                var params = Object.fromEntries(urlSearchParams.entries());
                return params;
            }();

            var toggles = {
                test: queryParams.hasOwnProperty("test")
            };           

            function getCenterOfUsa() {
                return {
                    latitude: 37.0902,
                    longitude: -95.7129
                };
            }

            if (!Geolocation.getCurrentPosition) {
                Geolocation.getCurrentPosition = function getCurrentPosition() {
                    return {
                        coords: getCenterOfUsa()
                    }
                };
            }

            function toGMapsPosition(geolocationCoord) {
                return {
                    lat: geolocationCoord.latitude,
                    lng: geolocationCoord.longitude
                };
            }

            function dump(o) {
                console.log(JSON.stringify(o));
            }

            function initMap() {
                var data = [];
                map = new google.maps.Map(document.getElementById("map"), {
                    center: toGMapsPosition(getCenterOfUsa()),
                    zoom: 18,
                    disableDefaultUI: true
                });

                function onCheckinDataReceived(coordList) {
                    coordList.forEach(function(coord) {
                        var gmapsPosition = toGMapsPosition(coord);
                        var marker = new google.maps.Marker({
                            position: gmapsPosition,
                            map: map,
                            title: "here's me!"
                        });

                        data.push(gmapsPosition);
                    });

                    var bounds = getBounds(data);
                
                    map.panToBounds(bounds, 0);
                    map.fitBounds(bounds, 0);
                }

                window.onCheckinDataReceived = onCheckinDataReceived;

                if (toggles.test) {
                    console.log("In test mode.");
                    var testData = getTestData();
                    testData.forEach(function(item, idx) {
                        setTimeout(function() { onCheckinDataReceived([item]); }, 500 * idx);
                    });
                }                
            }

            function getBounds(coordList) {
                // these values are picked to guarantee that the first coordinate's
                // values will override them.
                var latMin = 90, latMax = -90, lngMin = 180, lngMax = -180;

                coordList.forEach(function(coords) {
                    if (coords.lat < latMin) {
                        latMin = coords.lat;
                    }
                    if (coords.lat > latMax) {
                        latMax = coords.lat;
                    }
                    if (coords.lng < lngMin) {
                        lngMin = coords.lng;
                    }
                    if (coords.lng > lngMax) {
                        lngMax = coords.lng;
                    }
                });

                return {
                    north: Math.max(latMax, latMin + 1),
                    south: latMin,
                    east: Math.max(lngMax, lngMin + 1),
                    west: lngMin
                };
            }

            function random(range) {
                return range.min + (range.max - range.min) * Math.random()
            }

            function getTestData() {
                var a = [];
                var dataPoints = 100;
                var latitudeRange = { min: 28.696, max: 48.317 };
                var longitudeRange = { max: -76.515, min: -118.692 };
                for (var i=0; i < 100; i++) {
                    a.push({
                        latitude: random(latitudeRange),
                        longitude: random(longitudeRange)
                    });
                }
                return a;
            }
        </script>

        <script type="module">
            import { initializeApp } from "https://www.gstatic.com/firebasejs/9.6.9/firebase-app.js";
            import { getDatabase, ref, get, onChildAdded } from "https://www.gstatic.com/firebasejs/9.6.9/firebase-database.js";

            const app = initializeApp(firebaseConfig);

            function getCheckinData() {
                const db = getDatabase();
                const checkinsListRef = ref(db, 'checkins');

                onChildAdded(checkinsListRef, function(snapshot) {
                    if (!snapshot.val()) {
                        return;
                    }
                    var location = snapshot.val().location;
                    window.onCheckinDataReceived([ location ]);
                });
            }

            getCheckinData();
        </script>
        <canvas id="qr"></canvas>
        <script src="https://cdnjs.cloudflare.com/ajax/libs/qrious/4.0.2/qrious.min.js"></script>
        <script>
        (function() {
            var checkinUrl = new URL('checkin.html', window.location.href).toString()
            console.log(checkinUrl);
            var qr = new QRious({
                element: document.getElementById('qr'),
                value: checkinUrl,
                size: 200
            });
        })();
            
        </script> 
    </body>
</html>